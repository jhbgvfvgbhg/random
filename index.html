<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Pokemon Randomizer</title>
    <meta name="color-scheme" content="dark">
</head>
<body>
    <label for="rompicker">Select Pok√©mon ROM:</label>
    <input type="file" id="rompicker" accept=".gb,.sgb,.gbc,.gba,.nds">
    <p>When the app starts, find your ROM in the <code>/str/</code> folder.</p>
    <p><strong>Save your randomized ROM in the <code>/files/</code> folder.</strong></p>
    <p><button id="save">Download contents of <code>/files/</code> folder</button></p>
    <p>Tip: if the app stops working, try a <a href="https://www.howtogeek.com/672607/how-to-hard-refresh-your-web-browser-to-bypass-your-cache/" target="_blank">hard refresh</a>. Also, <strong>the app will take a long time to load</strong>, so please be patient.</p>
<script src="https://cjrtnc.leaningtech.com/3.1/cj3loader.js"></script>
<script>
async function waitForCheerpJ() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 101; // Adjust if needed (higher = more waiting)

        const checkInterval = setInterval(() => {
            if (window.cheerpjFSCreateDir && window.cheerpjAddStringFile && window.cheerpjRunMain) {
                clearInterval(checkInterval);
                console.log("‚úÖ CheerpJ is ready!");
                resolve();
            } else {
                attempts++;
                console.log(`üîÑ Waiting for CheerpJ... (${attempts}/${maxAttempts})`);
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    reject(new Error("‚ùå CheerpJ failed to initialize."));
                }
            }
        }, 200); // Check every 200ms
    });
}

async function loadJAR() {
    console.log("üöÄ Initializing CheerpJ...");
    
    await cheerpjInit();

    try {
        console.log("‚è≥ Ensuring CheerpJ is fully ready...");
        await waitForCheerpJ();
    } catch (error) {
        console.error(error.message);
        return;
    }

    console.log("üìÇ Creating necessary directories...");
    try {
        cheerpjFSCreateDir("/app");
    } catch (error) {
        console.warn("‚ö†Ô∏è Directory /app already exists or failed to create.");
    }

    console.log("üîç Fetching JAR file...");
    const response = await fetch("UPR-FVX.jar");
    if (!response.ok) {
        console.error("‚ùå Failed to fetch JAR file:", response.statusText);
        return;
    }

    const jarData = await response.arrayBuffer();
    const jarArray = new Uint8Array(jarData);

    console.log("üìÇ Mounting JAR file...");
    try {
        cheerpjAddStringFile("/app/UPR-FVX.jar", jarArray);
    } catch (error) {
        console.error("‚ùå Error adding JAR file to filesystem:", error);
        return;
    }

    console.log("‚ñ∂Ô∏è Running JAR file...");
    try {
        cheerpjRunMain("com.dabomstew.pkrandom.gui.RandomizerGUI", []);
    } catch (error) {
        console.error("‚ùå Error running JAR file:", error);
    }
}

window.onload = loadJAR;
</script>
</body>
</html>
